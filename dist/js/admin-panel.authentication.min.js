/*! admin-panel.authentication 2017-07-31 */

function loginFormController(e,n,t){e.username="",e.password="",e.error="",e.submit=function(){e.error="",e.form.$valid&&(e.$emit("apLoad:start"),t.login(e.username,e.password,function(t){e.$emit("apLoad:finish"),!0===t?n.path("/"):e.error="Usuario o contraseña incorrectos"}))},this.$onInit=function(){t.checkLogin()||t.logout()},this.$postLink=function(){$("login-form").foundation()}}function loginController(e){this.$postLink=function(){$("login").foundation()}}angular.module("adminPanel.authentication",["ngStorage","ngRoute","adminPanel"]).config(["$routeProvider",function(e){e.when("/login",{})}]).config(["$httpProvider",function(e){e.interceptors.push("AuthenticationInterceptor")}]),angular.module("adminPanel.authentication").directive("apUser",["AuthenticationService","$location",function(e,n){return{restrict:"A",transclude:!0,link:function(t){function r(){t.user=e.checkLogin(),t.user&&"/login"===n.path()&&n.path("/")}r(),t.$on("$routeChangeStart",function(){r()})},templateUrl:"directive/user.template.html"}}]),angular.module("adminPanel.authentication").component("loginForm",{templateUrl:"login-form/login-form.template.html",controller:["$scope","$location","AuthenticationService",loginFormController]}),angular.module("adminPanel.authentication").component("login",{templateUrl:"login/login.template.html",controller:["$scope",loginController]}),angular.module("adminPanel.authentication").factory("AuthenticationInterceptor",["$q","$location","UserService","FirewallService",function(e,n,t,r){function i(){"/login"!==n.path()&&n.path("/login")}return{request:function(e){return r.isAllowedPath(n.path())?e:(e.headers.Authorization||(t.isLogged()?e.headers.Authorization="Bearer "+t.getToken():i()),e)},responseError:function(n){return 401===n.status&&(t.logout(),i()),e.reject(n)}}}]),angular.module("adminPanel.authentication").provider("AuthenticationService",function(){var e=["/login"],n=null,t=3600;this.setApiPath=function(e){if(!(e instanceof String)&&"string"!=typeof e)throw"The path must be a String.";return n=e,this},this.excludePaths=function(n){if(!(n instanceof Array))throw"The paths must be an Array of Strings";return e=n,this},this.setMaxSessionTime=function(e){if(!(e instanceof Number)&&"number"!=typeof e)throw"The time must be numeric";return t=e,this},this.$get=["$http","UserService","FirewallService",function(r,i,o){if(null===n)throw"The path must be initialized.";return o.setExcludePaths(e),{login:function(o,a,u){r.post(n+"/login",{_username:o,_password:a}).then(function(n){n.data&&n.data.token?(i.login({username:o,token:n.data.token,maxSessionTime:t,excludePaths:e}),r.defaults.headers.common.Authorization="Bearer "+n.data.token,u(!0)):u(!1)},function(e){u(!1,e)})},logout:function(){i.logout(),r.defaults.headers.common.Authorization=""},checkLogin:function(){return!!i.isLogged()&&(r.defaults.headers.common.Authorization="Bearer "+i.getToken(),!0)}}}]}),angular.module("adminPanel.authentication").service("FirewallService",[function(){var e=null,n=function(n){for(var t=0;t<e.length;t++)if(n.match(e[t]))return!0;return!1};this.setExcludePaths=function(n){e=n},this.isAllowedPath=function(t){return null!==e&&n(t)}}]),angular.module("adminPanel.authentication").service("UserService",["$localStorage",function(e){function n(){delete e.currentUser}this.login=function(n){n.timestamp=(new Date).getTime(),e.currentUser=n},this.logout=n,this.getUsername=function(){return e.currentUser?e.currentUser.username:""},this.isLogged=function(){var t=(new Date).getTime();return!!(e.currentUser&&t-e.currentUser.timestamp<1e3*e.currentUser.maxSessionTime)||(n(),!1)},this.getToken=function(){return e.currentUser?e.currentUser.token:""},this.setToken=function(n){return!!e.currentUser&&(e.currentUser.token=n,!0)},this.isGranted=function(n){return!(!e.currentUser||!e.currentUser.roles)&&-1!==e.currentUser.roles.indexOf(n)}}]),angular.module("adminPanel.authentication").run(["$templateCache",function(e){e.put("directive/user.template.html","<div ng-if=!user><login></login></div><div ng-if=user ng-transclude></div>"),e.put("login-form/login-form.template.html",'<form name=form ng-submit=submit() data-abide novalidate><div ng-if=error class="alert callout"><p><i class="fa fa-warning"></i><span ng-bind=error></span></p></div><label>Usuario <input name=username type=text ng-model=username required><span class=form-error>El usuario es requerido</span></label><label>Contraseña <input name=password type=password ng-model=password required><span class=form-error>La contraseña es requerida</span></label><label><input type=submit class=button value=Login></label></form>'),e.put("login/login.template.html","<div class=background><div class=top></div><div class=bottom></div></div><div class=container><ap-box class=login-form title=Login init=init()><login-form></login-form></ap-box></div>")}]);
/*! admin-panel.authentication 2017-09-20 */

function loginFormController(e,t,n){e.username="",e.password="",e.error="",e.submit=function(){e.error="",e.form.$valid&&(e.$emit("apLoad:start"),n.login(e.username,e.password,function(n){e.$emit("apLoad:finish"),!0===n?t.path("/"):e.error="Usuario o contraseña incorrectos"}))},this.$onInit=function(){n.checkLogin()||n.logout()},this.$postLink=function(){$("login-form").foundation()}}function loginController(e){this.$postLink=function(){$("login").foundation()}}angular.module("adminPanel.authentication",["ngStorage","ngRoute","adminPanel"]).config(["$routeProvider",function(e){e.when("/login",{})}]).config(["$httpProvider",function(e){e.interceptors.push("AuthenticationInterceptor")}]),angular.module("adminPanel.authentication").directive("apUser",["AuthenticationService","$location",function(e,t){return{restrict:"A",transclude:!0,link:function(n){function r(){n.user=e.checkLogin(),n.user&&"/login"===t.path()&&t.path("/")}r(),n.$on("$routeChangeStart",function(){r()})},templateUrl:"directive/user.template.html"}}]),angular.module("adminPanel.authentication").component("loginForm",{templateUrl:"login-form/login-form.template.html",controller:["$scope","$location","AuthenticationService",loginFormController]}),angular.module("adminPanel.authentication").component("login",{templateUrl:"login/login.template.html",controller:["$scope",loginController]}),angular.module("adminPanel.authentication").factory("AuthenticationInterceptor",["$q","$location","UserService","FirewallService",function(e,t,n,r){function i(){"/login"!==t.path()&&t.path("/login")}return{request:function(e){return n.setLogged(null),r.isAllowedPath(t.path())?(n.setLogged(!0),e):(e.headers.Authorization||(n.isLogged()?e.headers.Authorization="Bearer "+n.getToken():i()),e)},responseError:function(t){return 401===t.status&&(n.logout(),i()),e.reject(t)}}}]),angular.module("adminPanel.authentication").provider("AuthenticationService",function(){var e=["/login"],t=null,n=3600,r=!1;this.setApiPath=function(e){if(!(e instanceof String)&&"string"!=typeof e)throw"The path must be a String.";return t=e,this},this.excludePaths=function(t){if(!(t instanceof Array))throw"The paths must be an Array of Regex";return e=t,this},this.setMaxSessionTime=function(e){if(!(e instanceof Number)&&"number"!=typeof e)throw"The time must be numeric";return n=e,this},this.enableDebugMode=function(){return r=!0,this},this.$get=["$http","UserService","FirewallService",function(i,o,a){if(null===t)throw"The path must be initialized.";return r?a.setExcludePaths([/^./]):a.setExcludePaths(e),{login:function(r,a,u){i.post(t+"/login",{_username:r,_password:a}).then(function(t){t.data&&t.data.token?(o.login({username:r,token:t.data.token,maxSessionTime:n,excludePaths:e}),i.defaults.headers.common.Authorization="Bearer "+t.data.token,u(!0)):u(!1)},function(e){u(!1,e)})},logout:function(){o.logout(),i.defaults.headers.common.Authorization=""},checkLogin:function(){return!!o.isLogged()&&(i.defaults.headers.common.Authorization="Bearer "+o.getToken(),!0)}}}]}),angular.module("adminPanel.authentication").service("FirewallService",[function(){var e=[/^./],t=function(t){for(var n=0;n<e.length;n++)if(t.match(e[n]))return!0;return!1};this.setExcludePaths=function(t){e=t},this.isAllowedPath=function(n){return null!==e&&t(n)}}]),angular.module("adminPanel.authentication").service("UserService",["$localStorage",function(e){function t(){delete e.currentUser}var n=!1;this.login=function(t){t.timestamp=(new Date).getTime(),e.currentUser=t},this.logout=t,this.getUsername=function(){return e.currentUser?e.currentUser.username:""},this.isLogged=function(){if(!0===n)return!0;var r=(new Date).getTime();return!!(e.currentUser&&r-e.currentUser.timestamp<1e3*e.currentUser.maxSessionTime)||(t(),!1)},this.setLogged=function(e){n=e},this.getToken=function(){return e.currentUser?e.currentUser.token:""},this.setToken=function(t){return!!e.currentUser&&(e.currentUser.token=t,!0)},this.isGranted=function(t){return!(!e.currentUser||!e.currentUser.roles)&&-1!==e.currentUser.roles.indexOf(t)}}]),angular.module("adminPanel.authentication").run(["$templateCache",function(e){e.put("directive/user.template.html","<div ng-if=!user><login></login></div><div ng-if=user ng-transclude></div>"),e.put("login-form/login-form.template.html",'<form name=form ng-submit=submit() data-abide novalidate><div ng-if=error class="alert callout"><p><i class="fa fa-warning"></i><span ng-bind=error></span></p></div><label>Usuario <input name=username type=text ng-model=username required><span class=form-error>El usuario es requerido</span></label><label>Contraseña <input name=password type=password ng-model=password required><span class=form-error>La contraseña es requerida</span></label><label><input type=submit class=button value=Login></label></form>'),e.put("login/login.template.html","<div class=background><div class=top></div><div class=bottom></div></div><div class=container><ap-box class=login-form title=Login init=init()><login-form></login-form></ap-box></div>")}]);
/*! admin-panel.authentication 2018-02-09 */

function loginFormController(e,t,n){e.username="",e.password="",e.error="",e.submit=function(){e.error="",e.form.$valid&&(e.$emit("apLoad:start"),n.login(e.username,e.password,function(n){e.$emit("apLoad:finish"),!0===n?t.path("/"):e.error="Usuario o contraseña incorrectos"}))},this.$onInit=function(){n.checkLogin()||n.logout()},this.$postLink=function(){$("login-form").foundation()}}function loginController(e){this.$postLink=function(){$("login").foundation()}}angular.module("adminPanel.authentication",["ngStorage","ngRoute","adminPanel"]).config(["$routeProvider",function(e){e.when("/login",{})}]).config(["$httpProvider",function(e){e.interceptors.push("AuthenticationInterceptor")}]),angular.module("adminPanel.authentication").directive("apUser",["AuthenticationService","$location",function(e,t){return{restrict:"A",transclude:!0,link:function(n){function i(){n.user=e.checkLogin(),n.user&&"/login"===t.path()&&t.path("/")}i(),n.$on("$routeChangeStart",function(){i(),angular.element(document).ready(function(){n.$broadcast("userData",n.user)})})},templateUrl:"directive/user.template.html"}}]),angular.module("adminPanel.authentication").component("loginForm",{templateUrl:"login-form/login-form.template.html",controller:["$scope","$location","AuthenticationService",loginFormController]}),angular.module("adminPanel.authentication").component("login",{templateUrl:"login/login.template.html",controller:["$scope",loginController]}),angular.module("adminPanel.authentication").factory("AuthenticationInterceptor",["$q","$location","UserService","FirewallService",function(e,t,n,i){function o(){"/login"!==t.path()&&t.path("/login")}return{request:function(e){return n.setLogged(null),i.isAllowedPath(t.path())?(n.setLogged(!0),e):(e.headers.Authorization||(n.isLogged()?e.headers.Authorization="Bearer "+n.getToken():o()),e)},responseError:function(t){return 401===t.status&&(n.logout(),o()),e.reject(t)}}}]),angular.module("adminPanel.authentication").provider("AuthenticationService",function(){var e=["/login"],t=null,n=3600,i=!1;this.setApiPath=function(e){if(!(e instanceof String)&&"string"!=typeof e)throw"The path must be a String.";return t=e,this},this.excludePaths=function(t){if(!(t instanceof Array))throw"The paths must be an Array of Regex";return e=t,this},this.setMaxSessionTime=function(e){if(!(e instanceof Number)&&"number"!=typeof e)throw"The time must be numeric";return n=e,this},this.enableDebugMode=function(){return i=!0,this},this.$get=["$http","UserService","FirewallService",function(o,a,r){if(null===t)throw"The path must be initialized.";return i?r.setExcludePaths([/^./]):r.setExcludePaths(e),{login:function(i,r,s){o.post(t+"/login",{_username:i,_password:r}).then(function(t){t.data&&t.data.token?(a.login({token:t.data.token,maxSessionTime:n,excludePaths:e}),o.defaults.headers.common.Authorization="Bearer "+t.data.token,s(!0)):s(!1)},function(e){s(!1,e)})},logout:function(){a.logout(),o.defaults.headers.common.Authorization=""},checkLogin:function(){if(a.isLogged())return o.defaults.headers.common.Authorization="Bearer "+a.getToken(),a.getUserData();return null}}}]}),angular.module("adminPanel.authentication").service("FirewallService",[function(){var e=[/^./];this.setExcludePaths=function(t){e=t},this.isAllowedPath=function(t){return null!==e&&function(t){for(var n=0;n<e.length;n++)if(t.match(e[n]))return!0;return!1}(t)}}]),angular.module("adminPanel.authentication").service("TokenParserService",[function(){this.parseJwt=function(e){try{var t=e.split(".")[1].replace("-","+").replace("_","/"),n=JSON.parse(window.atob(t));if(!n.username)throw"The token does not contain username in payload";if(!n.exp)throw"The token does not contain exp in payload";if(!n.iat)throw"The token does not contain iat in payload";return n}catch(e){throw console.error(e),"Token decoding error"}}}]),angular.module("adminPanel.authentication").factory("UserFactory",function(){return{data:null,setData:function(e){this.data={username:e.username||"",roles:e.roles||null}},getData:function(){return this.data},deleteData:function(){this.data=null}}}),angular.module("adminPanel.authentication").service("UserService",["$localStorage","UserFactory","TokenParserService",function(e,t,n){var i=!1;function o(){e.session&&delete e.session,t.deleteData()}this.login=function(i){var o=n.parseJwt(i.token);t.setData({username:o.username,roles:o.roles});var a=new Date(1e3*o.exp),r=new Date(1e3*(o.iat+i.maxSessionTime));e.session={access_token:i.token,exp:Math.min(r,a),excludePaths:i.excludePaths}},this.initData=function(){var e=this.getToken();if(!e)return null;var i=n.parseJwt(e),o={username:i.username,roles:i.roles};return t.setData(o),o},this.logout=o,this.getUserData=function(){var e=t.getData();e||(e=this.initData());return e},this.getUsername=function(){var e=this.getUserData();if(!e)return null;return e.username},this.getRoles=function(){var e=this.getUserData();if(!e)return null;return e.roles},this.isLogged=function(){if(!0===i)return!0;var t=(new Date).getTime();if(e.session&&t<e.session.exp)return!0;return o(),!1},this.setLogged=function(e){i=e},this.getToken=function(){if(e.session)return e.session.access_token;return""},this.setToken=function(t){if(!e.session)return!1;return e.session.access_token=t,!0},this.isGranted=function(t){if(e.session&&e.session.roles)return-1!==e.session.roles.indexOf(t);return!1}}]),angular.module("adminPanel.authentication").run(["$templateCache",function(e){e.put("directive/user.template.html","<div ng-if=!user><login></login></div><div ng-if=user ng-transclude></div>"),e.put("login-form/login-form.template.html",'<form name=form ng-submit=submit() data-abide novalidate><div ng-if=error class="alert callout"><p><i class="fa fa-warning"></i><span ng-bind=error></span></p></div><label>Usuario<div class=input-group><span class=input-group-label><i class="fa fa-user-o" aria-hidden=true></i></span><input class=input-group-field name=username type=text ng-model=username required></div><span class=form-error>El usuario es requerido</span></label><label>Contraseña<div class=input-group><span class=input-group-label><i class="fa fa-lock" aria-hidden=true></i></span><input class=input-group-field name=password type=password ng-model=password required></div><span class=form-error>La contraseña es requerida</span></label><div class=row><input type=submit class=button value=Ingresar></div></form>'),e.put("login/login.template.html","<div class=container><ap-box class=login-form title=Login init=init()><login-form></login-form></ap-box></div>")}]);
/*! admin-panel.authentication 2017-06-26 */

function loginFormController(n,e,t){n.username="",n.password="",n.error="",n.submit=function(){n.error="",n.form.$valid&&(n.$emit("apLoad:start"),t.login(n.username,n.password,function(t){n.$emit("apLoad:finish"),!0===t?e.path("/"):n.error="Usuario o contraseña incorrectos"}))},this.$onInit=function(){t.checkLogin()||t.logout()},this.$postLink=function(){$("login-form").foundation()}}function loginController(n){this.$postLink=function(){$("login").foundation()}}angular.module("adminPanel.authentication",["ngStorage","ngRoute","adminPanel"]).config(["$routeProvider",function(n){n.when("/login",{})}]).config(["$httpProvider",function(n){n.interceptors.push("AuthenticationInterceptor")}]),angular.module("adminPanel.authentication").directive("apUser",["AuthenticationService","$location",function(n,e){return{restrict:"A",transclude:!0,link:function(t){function o(){t.user=n.checkLogin(),t.user&&"/login"===e.path()&&e.path("/")}o(),t.$on("$routeChangeStart",function(){o()})},templateUrl:"components/admin-panel/modules/authorization/directive/user.template.html"}}]),angular.module("adminPanel.authentication").component("loginForm",{templateUrl:"components/admin-panel/modules/authorization/login-form/login-form.template.html",controller:["$scope","$location","AuthenticationService",loginFormController]}),angular.module("adminPanel.authentication").component("login",{templateUrl:"components/admin-panel/modules/authorization/login/login.template.html",controller:["$scope",loginController]}),angular.module("adminPanel.authentication").factory("AuthenticationInterceptor",["$q","$location","UserService","FirewallService",function(n,e,t,o){function i(){"/login"!==e.path()&&e.path("/login")}return{request:function(n){return o.isAllowedPath(e.path())?n:(n.headers.Authorization||(t.isLogged()?n.headers.Authorization="Bearer "+t.getToken():i()),n)},responseError:function(e){return 401===e.status&&(t.logout(),i()),n.reject(e)}}}]),angular.module("adminPanel.authentication").provider("AuthenticationService",function(){var n=["/login"],e=null,t=3600;this.setApiPath=function(n){if(!(n instanceof String)&&"string"!=typeof n)throw"The path must be a String.";return e=n,this},this.excludePaths=function(e){if(!(e instanceof Array))throw"The paths must be an Array of Strings";return n=e,this},this.setMaxSessionTime=function(n){if(!(n instanceof Number)&&"number"!=typeof n)throw"The time must be numeric";return t=n,this},this.$get=["$http","UserService","FirewallService",function(o,i,r){if(null===e)throw"The path must be initialized.";return r.setExcludePaths(n),{login:function(r,a,l){o.post(e+"/login",{_username:r,_password:a}).then(function(e){e.data&&e.data.token?(i.login({username:r,token:e.data.token,maxSessionTime:t,excludePaths:n}),o.defaults.headers.common.Authorization="Bearer "+e.data.token,l(!0)):l(!1)},function(n){l(!1,n)})},logout:function(){i.logout(),o.defaults.headers.common.Authorization=""},checkLogin:function(){return!!i.isLogged()&&(o.defaults.headers.common.Authorization="Bearer "+i.getToken(),!0)}}}]}),angular.module("adminPanel.authentication").service("FirewallService",[function(){var n=null;this.setExcludePaths=function(e){n=e},this.isAllowedPath=function(e){return null!==n&&-1!==n.indexOf(e)}}]),angular.module("adminPanel.authentication").service("UserService",["$localStorage",function(n){function e(){delete n.currentUser}this.login=function(e){e.timestamp=(new Date).getTime(),n.currentUser=e},this.logout=e,this.getUsername=function(){return n.currentUser?n.currentUser.username:""},this.isLogged=function(){var t=(new Date).getTime();return!!(n.currentUser&&t-n.currentUser.timestamp<1e3*n.currentUser.maxSessionTime)||(e(),!1)},this.getToken=function(){return n.currentUser?n.currentUser.token:""},this.setToken=function(e){return!!n.currentUser&&(n.currentUser.token=e,!0)},this.isGranted=function(e){return!(!n.currentUser||!n.currentUser.roles)&&-1!==n.currentUser.roles.indexOf(e)}}]),angular.module("templates-dist",["directive/user.template.html","login-form/login-form.template.html","login/login.template.html"]),angular.module("directive/user.template.html",[]).run(["$templateCache",function(n){n.put("directive/user.template.html",'<div ng-if="!user">\n    <login></login>\n</div>\n<div ng-if="user" ng-transclude></div>')}]),angular.module("login-form/login-form.template.html",[]).run(["$templateCache",function(n){n.put("login-form/login-form.template.html",'<form name="form" ng-submit="submit()" data-abide novalidate>\n    <div ng-if="error" class="alert callout">\n        <p><i class="fa fa-warning"></i><span ng-bind="error"></span></p>\n    </div>\n    <label>Usuario\n        <input name="username" type="text" ng-model="username" required>\n        <span class="form-error">El usuario es requerido</span>\n    </label>\n    <label>Contraseña\n        <input name="password" type="password" ng-model="password" required>\n        <span class="form-error">La contraseña es requerida</span>\n    </label>\n    <label>\n        <input type="submit" class="button" value="Login">\n    </label>\n</form>')}]),angular.module("login/login.template.html",[]).run(["$templateCache",function(n){n.put("login/login.template.html",'<div class="background">\n    <div class="top"></div>\n    <div class="bottom"></div>\n</div>\n<div class="container">\n    <ap-box class="login-form" title="Login" init="init()">\n        <login-form></login-form>\n    </ap-box>\n</div>')}]);
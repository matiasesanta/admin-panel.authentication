/*! admin-panel.authentication 2018-11-04 */

function loginFormController(n,t,e){n.username="",n.password="",n.error="",n.submit=function(){n.error="",n.form.$valid&&(n.$emit("apLoad:start"),e.login(n.username,n.password,function(e){n.$emit("apLoad:finish"),!0===e?t.path("/"):n.error="Usuario o contraseña incorrectos"}))},this.$onInit=function(){e.checkLogin()||e.logout()},this.$postLink=function(){$("login-form").foundation()}}function loginController(e){this.$postLink=function(){$("login").foundation()}}angular.module("adminPanel.authentication",["ngStorage","ngRoute","adminPanel"]).config(["$routeProvider",function(e){e.when("/login",{})}]).config(["$httpProvider",function(e){e.interceptors.push("AuthenticationInterceptor")}]),angular.module("adminPanel.authentication").directive("apUser",["AuthenticationService","$location",function(t,i){return{restrict:"A",transclude:!0,link:function(e){function n(){e.user=t.checkLogin(),e.user&&"/login"===i.path()&&i.path("/")}n(),e.$on("$routeChangeStart",function(){n(),angular.element(document).ready(function(){e.$broadcast("userData",e.user)})})},templateUrl:"directive/user.template.html"}}]),angular.module("adminPanel.authentication").component("loginForm",{templateUrl:"login-form/login-form.template.html",controller:["$scope","$location","AuthenticationService",loginFormController]}),angular.module("adminPanel.authentication").component("login",{templateUrl:"login/login.template.html",controller:["$scope",loginController]}),angular.module("adminPanel.authentication").factory("AuthenticationInterceptor",["$q","$location","UserService","FirewallService",function(n,t,i,o){function a(){"/login"!==t.path()&&t.path("/login")}return{request:function(e){return i.setLogged(null),o.isAllowedPath(t.path())?i.setLogged(!0):e.headers.Authorization||(i.isLogged()?e.headers.Authorization="Bearer "+i.getToken():a()),e},responseError:function(e){return 401===e.status&&(i.logout(),a()),n.reject(e)}}}]),angular.module("adminPanel.authentication").provider("AuthenticationService",function(){var a=["/login"],r=null,s=3600,n=!1;this.setApiPath=function(e){if(!(e instanceof String)&&"string"!=typeof e)throw"The path must be a String.";return r=e,this},this.excludePaths=function(e){if(!(e instanceof Array))throw"The paths must be an Array of Regex";return a=e,this},this.setMaxSessionTime=function(e){if(!(e instanceof Number)&&"number"!=typeof e)throw"The time must be numeric";return s=e,this},this.enableDebugMode=function(){return n=!0,this},this.$get=["$http","UserService","FirewallService",function(i,o,e){if(null===r)throw"The path must be initialized.";return n?e.setExcludePaths([/^./]):e.setExcludePaths(a),{login:function(e,n,t){i.post(r+"/login",{_username:e,_password:n}).then(function(e){e.data&&e.data.token?(o.login({token:e.data.token,maxSessionTime:s,excludePaths:a}),i.defaults.headers.common.Authorization="Bearer "+e.data.token,t(!0)):t(!1)},function(e){t(!1,e)})},logout:function(){o.logout(),i.defaults.headers.common.Authorization=""},checkLogin:function(){if(o.isLogged())return i.defaults.headers.common.Authorization="Bearer "+o.getToken(),o.getUserData();return null}}}]}),angular.module("adminPanel.authentication").service("FirewallService",[function(){var t=[/^./];this.setExcludePaths=function(e){t=e},this.isAllowedPath=function(e){return null!==t&&function(e){for(var n=0;n<t.length;n++)if(e.match(t[n]))return!0;return!1}(e)}}]),angular.module("adminPanel.authentication").service("TokenParserService",[function(){this.parseJwt=function(e){try{var n=e.split(".")[1].replace("-","+").replace("_","/"),t=JSON.parse(window.atob(n));if(!t.username)throw"The token does not contain username in payload";if(!t.exp)throw"The token does not contain exp in payload";if(!t.iat)throw"The token does not contain iat in payload";return t}catch(e){throw console.error(e),"Token decoding error"}}}]),angular.module("adminPanel.authentication").factory("UserFactory",function(){return{data:null,setData:function(e){this.data={username:e.username||"",roles:e.roles||null}},getData:function(){return this.data},deleteData:function(){this.data=null}}}),angular.module("adminPanel.authentication").service("UserService",["$localStorage","UserFactory","TokenParserService",function(o,a,r){var n=!1;function t(){o.session&&delete o.session,a.deleteData()}this.login=function(e){var n=r.parseJwt(e.token);a.setData({username:n.username,roles:n.roles});var t=new Date(1e3*n.exp),i=new Date(1e3*(n.iat+e.maxSessionTime));o.session={access_token:e.token,exp:Math.min(i,t),excludePaths:e.excludePaths}},this.initData=function(){var e=this.getToken();if(!e)return null;var n=r.parseJwt(e),t={username:n.username,roles:n.roles};return a.setData(t),t},this.logout=t,this.getUserData=function(){var e=a.getData();e||(e=this.initData());return e},this.getUsername=function(){var e=this.getUserData();if(!e)return null;return e.username},this.getRoles=function(){var e=this.getUserData();if(!e)return null;return e.roles},this.isLogged=function(){if(!0===n)return!0;var e=(new Date).getTime();if(o.session&&e<o.session.exp)return!0;return t(),!1},this.setLogged=function(e){n=e},this.getToken=function(){if(o.session)return o.session.access_token;return""},this.setToken=function(e){if(!o.session)return!1;return o.session.access_token=e,!0},this.isGranted=function(e){if(o.session&&o.session.roles)return-1!==o.session.roles.indexOf(e);return!1}}]),angular.module("adminPanel.authentication").run(["$templateCache",function(e){e.put("directive/user.template.html","<div ng-if=!user><login></login></div><div ng-if=user ng-transclude></div>"),e.put("login-form/login-form.template.html",'<form name=form ng-submit=submit() data-abide novalidate><div ng-if=error class="alert callout"><p><i class="fa fa-warning"></i><span ng-bind=error></span></p></div><label>Usuario<div class=input-group><span class=input-group-label><i class="fas fa-user" aria-hidden=true></i></span><input class=input-group-field name=username type=text ng-model=username required></div><span class=form-error>El usuario es requerido</span></label><label>Contraseña<div class=input-group><span class=input-group-label><i class="fa fa-lock" aria-hidden=true></i></span><input class=input-group-field name=password type=password ng-model=password required></div><span class=form-error>La contraseña es requerida</span></label><input type=submit class=button value=Ingresar></form>'),e.put("login/login.template.html",'<div class="login-container row align-middle"><div class="large-4 large-offset-4 medium-6 medium-offset-3 columns"><ap-box class=login-form title=Login init=init()><login-form></login-form></ap-box></div></div>')}]);
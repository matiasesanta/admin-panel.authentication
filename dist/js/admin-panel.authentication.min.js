/*! admin-panel.authentication 2018-09-20 */

function loginFormController(t,n,e){t.username="",t.password="",t.error="",t.submit=function(){t.error="",t.form.$valid&&(t.$emit("apLoad:start"),e.login(t.username,t.password,function(e){t.$emit("apLoad:finish"),!0===e?n.path("/"):t.error="Usuario o contraseña incorrectos"}))},this.$onInit=function(){e.checkLogin()||e.logout()},this.$postLink=function(){$("login-form").foundation()}}function loginController(e){this.$postLink=function(){$("login").foundation()}}angular.module("adminPanel.authentication",["ngStorage","ngRoute","adminPanel"]).config(["$routeProvider",function(e){e.when("/login",{})}]).config(["$httpProvider",function(e){e.interceptors.push("AuthenticationInterceptor")}]),angular.module("adminPanel.authentication").directive("apUser",["AuthenticationService","$location",function(n,i){return{restrict:"A",transclude:!0,link:function(e){function t(){e.user=n.checkLogin(),e.user&&"/login"===i.path()&&i.path("/")}t(),e.$on("$routeChangeStart",function(){t(),angular.element(document).ready(function(){e.$broadcast("userData",e.user)})})},templateUrl:"directive/user.template.html"}}]),angular.module("adminPanel.authentication").component("loginForm",{templateUrl:"login-form/login-form.template.html",controller:["$scope","$location","AuthenticationService",loginFormController]}),angular.module("adminPanel.authentication").component("login",{templateUrl:"login/login.template.html",controller:["$scope",loginController]}),angular.module("adminPanel.authentication").factory("AuthenticationInterceptor",["$q","$location","UserService","FirewallService",function(t,n,i,a){function o(){"/login"!==n.path()&&n.path("/login")}return{request:function(e){return i.setLogged(null),a.isAllowedPath(n.path())?i.setLogged(!0):e.headers.Authorization||(i.isLogged()?e.headers.Authorization="Bearer "+i.getToken():o()),e},responseError:function(e){return 401===e.status&&(i.logout(),o()),t.reject(e)}}}]),angular.module("adminPanel.authentication").provider("AuthenticationService",function(){var o=["/login"],r=null,s=3600,t=!1;this.setApiPath=function(e){if(!(e instanceof String)&&"string"!=typeof e)throw"The path must be a String.";return r=e,this},this.excludePaths=function(e){if(!(e instanceof Array))throw"The paths must be an Array of Regex";return o=e,this},this.setMaxSessionTime=function(e){if(!(e instanceof Number)&&"number"!=typeof e)throw"The time must be numeric";return s=e,this},this.enableDebugMode=function(){return t=!0,this},this.$get=["$http","UserService","FirewallService",function(i,a,e){if(null===r)throw"The path must be initialized.";return t?e.setExcludePaths([/^./]):e.setExcludePaths(o),{login:function(e,t,n){i.post(r+"/login",{_username:e,_password:t}).then(function(e){e.data&&e.data.token?(a.login({token:e.data.token,maxSessionTime:s,excludePaths:o}),i.defaults.headers.common.Authorization="Bearer "+e.data.token,n(!0)):n(!1)},function(e){n(!1,e)})},logout:function(){a.logout(),i.defaults.headers.common.Authorization=""},checkLogin:function(){if(a.isLogged())return i.defaults.headers.common.Authorization="Bearer "+a.getToken(),a.getUserData();return null}}}]}),angular.module("adminPanel.authentication").service("FirewallService",[function(){var n=[/^./];this.setExcludePaths=function(e){n=e},this.isAllowedPath=function(e){return null!==n&&function(e){for(var t=0;t<n.length;t++)if(e.match(n[t]))return!0;return!1}(e)}}]),angular.module("adminPanel.authentication").service("TokenParserService",[function(){this.parseJwt=function(e){try{var t=e.split(".")[1].replace("-","+").replace("_","/"),n=JSON.parse(window.atob(t));if(!n.username)throw"The token does not contain username in payload";if(!n.exp)throw"The token does not contain exp in payload";if(!n.iat)throw"The token does not contain iat in payload";return n}catch(e){throw console.error(e),"Token decoding error"}}}]),angular.module("adminPanel.authentication").factory("UserFactory",function(){return{data:null,setData:function(e){this.data={username:e.username||"",roles:e.roles||null}},getData:function(){return this.data},deleteData:function(){this.data=null}}}),angular.module("adminPanel.authentication").service("UserService",["$localStorage","UserFactory","TokenParserService",function(a,o,r){var t=!1;function n(){a.session&&delete a.session,o.deleteData()}this.login=function(e){var t=r.parseJwt(e.token);o.setData({username:t.username,roles:t.roles});var n=new Date(1e3*t.exp),i=new Date(1e3*(t.iat+e.maxSessionTime));a.session={access_token:e.token,exp:Math.min(i,n),excludePaths:e.excludePaths}},this.initData=function(){var e=this.getToken();if(!e)return null;var t=r.parseJwt(e),n={username:t.username,roles:t.roles};return o.setData(n),n},this.logout=n,this.getUserData=function(){var e=o.getData();e||(e=this.initData());return e},this.getUsername=function(){var e=this.getUserData();if(!e)return null;return e.username},this.getRoles=function(){var e=this.getUserData();if(!e)return null;return e.roles},this.isLogged=function(){if(!0===t)return!0;var e=(new Date).getTime();if(a.session&&e<a.session.exp)return!0;return n(),!1},this.setLogged=function(e){t=e},this.getToken=function(){if(a.session)return a.session.access_token;return""},this.setToken=function(e){if(!a.session)return!1;return a.session.access_token=e,!0},this.isGranted=function(e){if(a.session&&a.session.roles)return-1!==a.session.roles.indexOf(e);return!1}}]),angular.module("adminPanel.authentication").run(["$templateCache",function(e){e.put("directive/user.template.html","<div ng-if=!user><login></login></div><div ng-if=user ng-transclude></div>"),e.put("login-form/login-form.template.html",'<form name=form ng-submit=submit() data-abide novalidate><div ng-if=error class="alert callout"><p><i class="fa fa-warning"></i><span ng-bind=error></span></p></div><label>Usuario<div class=input-group><span class=input-group-label><i class="fas fa-user" aria-hidden=true></i></span><input class=input-group-field name=username type=text ng-model=username required></div><span class=form-error>El usuario es requerido</span></label><label>Contraseña<div class=input-group><span class=input-group-label><i class="fa fa-lock" aria-hidden=true></i></span><input class=input-group-field name=password type=password ng-model=password required></div><span class=form-error>La contraseña es requerida</span></label><div class=row><input type=submit class=button value=Ingresar></div></form>'),e.put("login/login.template.html","<div class=container><ap-box class=login-form title=Login init=init()><login-form></login-form></ap-box></div>")}]);